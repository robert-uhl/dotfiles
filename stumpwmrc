;; -*-lisp-*-
;debian=sbcl
(in-package :stumpwm-user)

(ql:quickload '(:clx-truetype
                :ttf-fonts
                :split-sequence
                :bordeaux-threads
                :dbus))

(set-font (make-instance 'xft:font :family "Source Code Pro Semibold" :subfamily "Regular" :size 12))

(ql:quickload :swank)

(let ((server-running nil))
  (defcommand swank () ()
    "Toggle the swank server on/off"
    (if server-running
        (progn
          (swank:stop-server 4005)
          (echo-string
           (current-screen)
           "Stopping swank.")
          (setf server-running nil))
        (progn
          (swank:create-server :port 4005
                               :style swank:*communication-style*
                               :dont-close t)
          (echo-string
           (current-screen)
           "Starting swank. M-x slime-connect RET RET, then (in-package stumpwm).")
          (setf server-running t))))

  (defcommand quit-swank () ()
              (when server-running
                (swank:stop-server 4005)
                (setf server-running nil)))

  (add-hook *quit-hook* (lambda () (when server-running (swank:stop-server 4005))))
  (add-hook stumpwm::*restart-hook* (lambda () (when server-running (swank:stop-server 4005)))))

(handler-case (swank)
  (sb-bsd-sockets:address-in-use-error () (continue)))

(define-key *top-map* (kbd "s-w") "windows")
(define-key *top-map* (kbd "s-!") "exec")

(set-prefix-key (kbd "C-1"))

(setf *mouse-focus-policy* :click) ;; :click, :ignore, :sloppy

(defcommand chromium () ()
  "run chromium"
  (run-or-raise "chromium-browser" '(:instance "Chromium")))

(defcommand firefox () ()
  "run firefox"
  (run-or-raise "firefox" '(:class "Firefox")))

(define-key *top-map* (kbd "C-M-6") "firefox")

(defcommand conkeror () ()
  "run conkeror"
  (run-or-raise "conkeror" '(:class "Conkeror")))

(define-key *top-map* (kbd "C-M-8") "conkeror")

(defcommand virtualbox () ()
  "switch to VirtualBox"
  (run-or-raise "VirtualBox --startvm \"Windows\"" '(:class "VirtualBox")))

(define-key *top-map* (kbd "C-M-4") "virtualbox")

(defcommand pidgin-chat-window () ()
  "Raise pidgin-chat-window"
  (run-or-raise "pidgin" '(:class "Pidgin" :role "conversation")))

;; (define-key *top-map* (kbd "C-M-2") "pidgin-chat-window")

(defcommand pidgin () ()
  "Run pidgin"
  (run-or-raise "pidgin" '(:class "Pidgin" :role "buddy_list")))

(defcommand start-emacs () ()
            "start emacs dæmon"
            (run-shell-command "emacs --daemon"))

(defcommand stop-emacs () ()
            "stop emacs dæmon"
            (run-shell-command "emacsclient -e '(save-buffers-kill-emacs)'"))

(start-emacs)

(add-hook *quit-hook* #'stop-emacs)

;;(let ((sb-ext:run-program "/usr/bin/env" '("emacs" "--daemon"))))

(defcommand emacs () ()
  "run emacs"
  (run-or-raise "/usr/local/bin/emacsclient -c -a ''" '(:instance "emacs")))

(defcommand conkeror () ()
  "run conkeror"
  (run-or-raise "/usr/local/bin/conkeror" '(:class "Conkeror")))

;;(define-key *top-map* (kbd "C-M-8") "pidgin")

#|
;; Show time, cpu usage and network traffic in the modeline
(setf *screen-mode-line-format*
(list '(:eval (run-shell-command "date '+%R, %F %a'|tr -d [:cntrl:]" t)) " | %t | %c| %l | [^B%n^b] %W"))

(define-key *top-map* (kbd "M-4") "emacs")
(define-key *top-map* (kbd "M-F9") "loadrc")
(define-key *top-map* (kbd "Pause") "gother")
(define-key *top-map* (kbd "C-Pause") "grouplist")

;; Some keybindings for the defined prefix key:
(define-key *root-map* (kbd "DEL") "repack-window-numbers")
(define-key *root-map* (kbd "I") "show-window-properties")

|#

(clear-window-placement-rules)
;; (gnew "Terminal")
;; (gnew "Development")
;; (gnew "Web")

;; (define-frame-preference "Terminal"
;;     (0 t t :class "Gnome-terminal"))

;; (define-frame-preference "Development"
;;     (1 t t :class "Emacs23")
;;     (0 t t :class "Eclipse"))

;; (define-frame-preference "Web"
;;     (0 t t :class "Chromium-browser"))

(defcommand urxvt () ()
  "Start an urxvt instance or switch to it, if it is already running."
  (run-or-raise "urxvt" '(:instance "urxvt")))
(define-key *root-map* (kbd "c") "urxvt")
(defcommand gnome-terminal () ()
  "Start an gnome-terminal instance or switch to it, if it is already running."
  (run-or-raise "gnome-terminal" '(:instance "gnome-terminal")))
(define-key *root-map* (kbd "c") "gnome-terminal")
(defcommand stterm () ()
  "Start an stterm or switch to it, if it is already running."
  (run-or-raise "st -c stterm-buhl -e tmux attach" '(:class "stterm-buhl")))
(define-key *root-map* (kbd "c") "stterm")

(defcommand suspend-dunst ()()
  "Suspend dunst notifications"
  (run-shell-command "killall -SIGUSR1 dunst"))

(defcommand resume-dunst ()()
  "Resume dunst notifications"
  (run-shell-command "killall -SIGUSR2 dunst"))

(defcommand lock-screen () ()
  (run-shell-command "xautolock -locknow"))

(defcommand unlock-screen () ()
  (run-shell-command "xautolock -unlocknow"))

(define-key *top-map* (kbd "s-l") "lock-screen")

(defvar *screen-map* (make-sparse-keymap))

(define-key *root-map* (kbd "/") '*screen-map*)

(defcommand home-display-layout () ()
  "Switch to my home display setup (portrait + laptop)"
  (run-shell-command "/home/buhl/.screenlayout/home.sh"))

(defcommand office-display-layout () ()
  "Switch to my office display setup (portrait + landscape)"
  (run-shell-command "/home/buhl/.screenlayout/office.sh"))

(defcommand standalone-display-layout () ()
  "Switch to laptop-only display"
  (run-shell-command "/home/buhl/.screenlayout/standalone.sh"))

(defcommand conference-room-display-layout () ()
            "Switch to conference-room display"
            (run-shell-command "/home/buhl/.screenlayout/conference-room.sh"))

(define-key *screen-map* (kbd "h") "home-display-layout")
(define-key *screen-map* (kbd "o") "office-display-layout")
(define-key *screen-map* (kbd "s") "standalone-display-layout")
(define-key *screen-map* (kbd "c") "conference-room-display-layout")

;;(run-shell-command "/home/buhl/bin/xflux -z 80203 -r 1")

(defvar %run-once% nil)

;; consider running dbus-launch and setting vars…

(unless %run-once%
  (run-shell-command "redshift -l 39.615186:-104.895381")
  (run-shell-command "exec xautolock -locker \"xset dpms 900 1200 1800 & (slock && xset -dpms) \" -corners 0-00 -time 5")
  ;; FIXME: can CLX handle this xset bit?
  ;;(run-shell-command "xset +dpms dpms 300 600 900")
  (run-shell-command "nm-applet --sm-disable")
  (run-shell-command "xbacklight -set 76")
  ;;(run-shell-command "xscreensaver")
  (setf %run-once% t))

(run-shell-command "synclient VerScrollDelta=-53")
(run-shell-command "feh --bg-tile ~/Pictures/geomatrix.png")

;; dbus-send --system --print-reply     --dest="org.freedesktop.UPower"     /org/freedesktop/UPower     org.freedesktop.UPower.Suspend

;; the mode-line is kinda nice
(setf *screen-mode-line-format* "%d [^B%n^b] %W"
      *time-modeline-string* "%d %b %y %H:%M"
      *mode-line-timeout* 15)

;; let's enable it everywhere
(defun enable-all-mode-lines ()
  (loop for screen in *screen-list*
        do (loop for head in (screen-heads screen)
                 do (enable-mode-line screen head t))))

(enable-all-mode-lines)

(defvar !old-group-sync-all-heads!
  (first (remove-if-not
          #'(lambda (x) (and (equalp (sb-mop:method-qualifiers x) '(:after))
                             (equalp (sb-mop:method-specializers x) (list (find-class 'group)))))
          (sb-mop:generic-function-methods #'group-sync-all-heads))))

;; update mode lines when the screen heads change

(defmethod group-sync-all-heads :after ((group group))
  (when !old-group-sync-all-heads!
    (funcall !old-group-sync-all-heads! group))
  (enable-all-mode-lines))

;; use Zenburn colours
;; default: ("black" "red" "green" "yellow" "blue" "magenta" "cyan" "white")
(setf *colors* '("#3f3f3f" "#cc9393" "#7f9f7f" "#f0dfaf"
                 "#8cd0d3" "#dc8cc3" "#93e0e3" "#dcdccc"))
(update-color-map (current-screen))

(let (;;(foreground-colour "darkseagreen1")
      (foreground-colour "#dcdccc")
      ;;(background-colour "grey25")
      (background-colour "#3f3f3f")
      ;;(border-colour "grey26")
      (border-colour "#2b2b2b")
      ;;(focus-colour "darkseagreen4")
      (focus-colour "#4f4f4f")
      ;;(unfocus-colour "grey25")
      (unfocus-colour "#383838"))
  (set-fg-color foreground-colour)
  (set-border-color foreground-colour)
  (set-focus-color focus-colour)
  (set-float-focus-color "#dfaf8f")
  (set-unfocus-color unfocus-colour)
  (set-float-unfocus-color "#366060")
  (set-msg-border-width 1)
  (setf *mode-line-foreground-color* "#5f5f5f"
        *mode-line-background-color* "#2b2b2b"
        *mode-line-border-color* border-colour))

;; An example of catching dbus lock messages.  This blocks until a message is received.
;;
;; (dbus:with-open-bus (bus (dbus:system-server-addresses)) (dbus:add-match bus :type :signal :interface "org.freedesktop.login1.Session" :member "Lock") (dbus:receive-message (dbus:bus-connection bus) ))

;; (let ((xdg-session (getenv "XDG_SESSION_ID")))
;;   (when (and xdg-session (string/= xdg-session ""))
;;     (bordeaux-threads:make-thread
;;      (dbus:with-open-bus (bus (dbus:system-server-addresses))
;;        (dbus:with-introspected-object (logind
;;                                        bus
;;                                        "/org/freedesktop/login1"
;;                                        "org.freedesktop.login1")
;;          (dbus:add-match bus
;;                          :type :signal
;;                          :interface "org.freedesktop.login1.Session"
;;                          :member "Lock"
;;                          :path (logind
;;                                 "org.freedesktop.login1.Manager"
;;                                 "GetSession"
;;                                 xdg-session))
;;          (dbus:add-match bus
;;                          :type :signal
;;                          :interface "org.freedesktop.login1.Session"
;;                          :member "Unlock"
;;                          :path (logind
;;                                 "org.freedesktop.login1.Manager"
;;                                 "GetSession"
;;                                 xdg-session))
;;          (loop for message = (dbus:receive-message (dbus:bus-connection bus))
;;             for member = (dbus:message-member message)
;;             do (cond
;;                  ((string= member "Lock") (lock-screen))
;;                  ((string= member "Unlock" (unlock-screen)))))))
;;      :name "handle-logind-locks")))

;; (bt:make-thread
;;  (lambda ()
;;    (dbus:with-open-bus (bus (dbus:system-server-addresses))
;;      (dbus:with-introspected-object (logind bus "/org/freedesktop/login1" "org.freedesktop.login1")
;;        (let ((session (stumpwm:getenv "XDG_SESSION_ID"))
;;              session-path)
;;          (when (and session (string/= session ""))
;;            (setf session-path
;;                  (logind "org.freedesktop.login1.Manager" "GetSession" session))
;;            (dbus:add-match bus :type :signal :interface "org.freedesktop.login1.Session" :member "Lock" :path session-path)))
;;        (dbus:add-match bus :type :signal :interface "org.freedesktop.login1.Manager" :member "PrepareForSleep")
;;        (loop for message = (dbus:receive-message (dbus:bus-connection bus))
;;           do (let ((member (dbus:message-member message)))
;;                (cond
;;                  ((and (string= member "PrepareForSleep")
;;                        (null (first (dbus:message-body message))))
;;                   (lock-screen))
;;                  ((string= member "Lock") (lock-screen))))))))
;;  :name "lock-on-dbus-signals")

(defcommand suspend () ()
  "suspend laptop"
  (lock-screen)
  (run-shell-command "dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 \"org.freedesktop.login1.Manager.Suspend\" boolean:true"))

(defcommand hibernate () ()
  "hibernate laptop"
  (lock-screen)
  (run-shell-command "dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 \"org.freedesktop.login1.Manager.Hibernate\" boolean:true"))

(ql:quickload :split-sequence)

;; (defvar *xdg-config-dirs*
;;   (append
;;    (let ((xdg-config-home (sb-ext:posix-getenv "XDG_CONFIG_HOME")))
;;      (if (and xdg-config-home (string/= "" xdg-config-home))
;;          (list (uiop/pathname:parse-unix-namestring xdg-config-home :type :directory))
;;          (list (parse-namestring (merge-pathnames ".config/" (user-homedir-pathname))))))
;;    (let ((xdg-config-dirs (sb-ext:posix-getenv "XDG_CONFIG_DIRS")))
;;     (if (and xdg-config-dirs (string/= "" xdg-config-dirs))
;;         (mapcar (lambda (x)
;;                   (uiop/pathname:parse-unix-namestring x :type :directory))
;;                 (split-sequence:split-sequence #\: xdg-config-dirs))
;;         (list (parse-namestring "/etc/xdg/"))))))

;; (defun search-paths (relative-path paths)
;;   (loop for path in paths
;;      for test-path = (merge-pathnames relative-path path)
;;      do (print test-path)
;;      when (uiop/filesystem:file-exists-p test-path)
;;     return test-path))

;;(search-paths "menus/applications.menu" *xdg-config-dirs*)

;; (dbus:with-open-bus (bus (dbus:system-server-addresses))
;;   (dbus:with-introspected-object (notifications bus "/org/freedesktop/login1" "org.freedesktop.login1")
;;     (notifications "org.freedesktop.login1.Manager" "Inhibit" "sleep" "Stump!" "testing" "block")))

;; brown noise: play -n synth 60:00 brownnoise

(defcommand darken-screen () ()
  "darken screen"
  (run-shell-command "xbacklight -dec 10"))

(defcommand lighten-screen () ()
  "lighten screen"
  (run-shell-command "xbacklight -inc 10"))

(define-key *top-map* (kbd "XF86MonBrightnessUp") "lighten-screen")
(define-key *top-map* (kbd "XF86MonBrightnessDown") "darken-screen")

(run-shell-command "xrandr --dpi 106")
